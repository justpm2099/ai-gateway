åšä¸€ä¸ª **AIèµ„æºèšåˆå±‚ï¼ˆAI Gateway / Orchestratorï¼‰**ã€‚

---

## 1. **ç†è®ºåŸºç¡€**

* **èšåˆæ„ä¹‰**ï¼šä¸åŒå‚å•†çš„AIå¼•æ“ï¼ˆå¦‚OpenAIã€DeepSeekã€Geminiã€ç¡…åŸºæµåŠ¨ç­‰ï¼‰åœ¨èƒ½åŠ›ã€æ€§èƒ½ã€ä»·æ ¼ã€åˆè§„ã€å»¶è¿Ÿä¸Šå­˜åœ¨å·®å¼‚ã€‚é€šè¿‡èšåˆï¼Œä½ å¯ä»¥å±è”½åº•å±‚å·®å¼‚ï¼Œå½¢æˆç»Ÿä¸€çš„APIä¾›ä¸Šå±‚è°ƒç”¨ã€‚
* **æŠ½è±¡å±‚ä½œç”¨**ï¼šç±»ä¼¼äº **æ•°æ®åº“ä¸­é—´ä»¶** æˆ– **æ”¯ä»˜èšåˆç½‘å…³**ï¼Œå®ƒèƒ½è®©ä½ çš„ä¸Šæ¸¸åº”ç”¨æ— éœ€å…³å¿ƒâ€œæˆ‘åˆ°åº•åœ¨è°ƒç”¨å“ªä¸€ä¸ªå¤§æ¨¡å‹â€ã€‚
* **æ ¸å¿ƒä»·å€¼**ï¼š

  * **ç»Ÿä¸€æ¥å£**ï¼šä½ çš„é¡¹ç›®åªéœ€å¯¹æ¥ä¸€æ¬¡APIã€‚
  * **çµæ´»è°ƒåº¦**ï¼šæ ¹æ®åœºæ™¯/æˆæœ¬/å»¶è¿Ÿï¼Œæ™ºèƒ½é€‰æ‹©ä¸åŒæ¨¡å‹ã€‚
  * **å¯æ‰©å±•æ€§**ï¼šåç»­å¢åŠ æˆ–æ›¿æ¢æ¨¡å‹æ— éœ€ä¿®æ”¹ä¸šåŠ¡å±‚ä»£ç ã€‚

---

## 2. **åº”ç”¨åœºæ™¯**

* **ä¼ä¸šå†…éƒ¨é¡¹ç›®**ï¼š
  åœ¨åŒä¸€ç»„ç»‡å†…ï¼Œå¼€å‘å›¢é˜Ÿåªéœ€è°ƒç”¨ä½ è®¾è®¡çš„ç»Ÿä¸€APIï¼Œä¸å¿…ä¸ºæ¯ä¸ªæ¨¡å‹å•ç‹¬å†™é€‚é…ã€‚
* **æˆæœ¬ä¼˜åŒ–**ï¼š
  åŒæ ·çš„ä»»åŠ¡ï¼Œå¯èƒ½DeepSeekåœ¨ä¸­æ–‡æ€§ä»·æ¯”é«˜ï¼ŒOpenAIåœ¨é€»è¾‘æ¨ç†å¼ºï¼ŒGeminiåœ¨å¤šæ¨¡æ€è¡¨ç°å¥½ â†’ ä½ çš„èšåˆå™¨å¯ä»¥åŠ¨æ€åˆ†æµã€‚
* **å¯é æ€§å¢å¼º**ï¼š
  å½“æŸä¸ªAPIæŒ‚æ‰æˆ–é™æµæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹ï¼Œæå‡æ•´ä½“æœåŠ¡å¯ç”¨æ€§ã€‚
* **åŠŸèƒ½è¡¥è¶³**ï¼š
  éƒ¨åˆ†æ¨¡å‹æ“…é•¿æ–‡æœ¬ç”Ÿæˆï¼Œéƒ¨åˆ†æ“…é•¿å¤šæ¨¡æ€ï¼Œèšåˆèƒ½æä¾›â€œä¸€ç«™å¼AIèƒ½åŠ›â€ã€‚

---

## 3. **ç°æœ‰è¿›å±•**

* **å•†ä¸šå±‚é¢**ï¼š

  * **OpenRouter** æœ¬èº«å°±æ˜¯åšå¤šæ¨¡å‹èšåˆçš„ï¼Œæä¾›ç»Ÿä¸€APIï¼Œåº•å±‚å¯¹æ¥OpenAIã€Anthropicç­‰ã€‚
  * **LangChain / LlamaIndex** ä¹Ÿæ”¯æŒå¤šæ¨¡å‹è·¯ç”±ï¼Œä½†ååº”ç”¨å±‚ï¼Œé€‚é…ä¸æ˜¯APIçº§åˆ«çš„ã€‚
* **æŠ€æœ¯å±‚é¢**ï¼š
  ä¸€äº›å…¬å¸åš **AI Gateway**ï¼ˆå¦‚Heliconeã€AnyScaleï¼‰ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä½ è®¾æƒ³çš„ä¸œè¥¿ã€‚

---

## 4. **æœªæ¥å‰æ™¯**

* **æ™ºèƒ½è°ƒåº¦**ï¼š
  æœªæ¥å¯åšâ€œæ¨¡å‹é€‰æ‹©ç­–ç•¥å¼•æ“â€ï¼Œæ¯”å¦‚ï¼š

  * çŸ­æ–‡æœ¬ â†’ ç”¨ä¾¿å®œæ¨¡å‹
  * ä»£ç ç”Ÿæˆ â†’ ç”¨ä¸“é•¿æ¨¡å‹
  * å…³é”®ä»»åŠ¡ â†’ ç”¨æœ€ç¨³çš„æ¨¡å‹
* **æ•°æ®é©±åŠ¨ä¼˜åŒ–**ï¼š
  é€šè¿‡è®°å½•è°ƒç”¨æ—¥å¿—ã€å“åº”æ—¶é—´ã€æˆåŠŸç‡ï¼Œåšå‡ºè‡ªåŠ¨è°ƒåº¦ç­–ç•¥ã€‚
* **ç§æœ‰åŒ–éƒ¨ç½²**ï¼š
  å¦‚æœä½ èšåˆè‡ªç ”/ç§æœ‰å¤§æ¨¡å‹ï¼Œä¹Ÿèƒ½æä¾›å®‰å…¨åˆè§„çš„ç»Ÿä¸€AIå±‚ã€‚
* **æ½œåœ¨äº§å“åŒ–**ï¼š
  è¿™ä¸ä»…èƒ½æœåŠ¡ä½ è‡ªæœ‰é¡¹ç›®ï¼Œè¿˜å¯ä»¥å¯¹å¤–ä½œä¸ºä¸€ä¸ª SaaS API å¹³å°å‡ºå”®ã€‚

---

## 5. **æŒ‘æˆ˜ä¸é£é™©**

* **æ¥å£é€‚é…å¤æ‚åº¦**ï¼šä¸åŒAPIåœ¨å‚æ•°ï¼ˆpromptæ ¼å¼ã€tokené™åˆ¶ã€æµå¼/éæµå¼è¾“å‡ºï¼‰ä¸Šå·®å¼‚å¤§ï¼Œéœ€è¦æ ‡å‡†åŒ–ã€‚
* **æ€§èƒ½å¼€é”€**ï¼šä½ çš„èšåˆå±‚ä¼šå¢åŠ ä¸€å±‚è½¬å‘å»¶è¿Ÿï¼Œéœ€è¦ä¼˜åŒ–ï¼ˆç¼“å­˜ã€ç›´è¿é€šé“ç­‰ï¼‰ã€‚
* **æˆæœ¬é€æ˜åº¦**ï¼šéœ€è¦æ¸…æ¥šè®°å½•è°ƒç”¨æ¥æºï¼Œé¿å…â€œè´¦å•æ··ä¹±â€ã€‚
* **å·®å¼‚ä¸¢å¤±**ï¼šç»Ÿä¸€æ¥å£å¯èƒ½ä¼šå±è”½éƒ¨åˆ†æ¨¡å‹ç‹¬æœ‰åŠŸèƒ½ï¼ˆä¾‹å¦‚Geminiçš„å¤šæ¨¡æ€ç‰¹æ€§ï¼‰ã€‚

---

## 6. **å¯¹æ¯”åˆ†æ**

| æ–¹æ¡ˆ                    | ä¼˜ç‚¹              | ç¼ºç‚¹              |
| --------------------- | --------------- | --------------- |
| **å•ä¸€æ¨¡å‹ç›´æ¥æ¥å…¥**          | ç®€å•ï¼Œå»¶è¿Ÿä½          | ä¸çµæ´»ï¼Œå®¹æ˜“å—é™æµå’Œæ€§èƒ½åˆ¶çº¦  |
| **ç›´æ¥ä½¿ç”¨OpenRouterç­‰å¹³å°** | æˆç†Ÿç¨³å®šï¼Œå¿«é€Ÿä¸Šçº¿       | ä¾èµ–ç¬¬ä¸‰æ–¹ï¼Œå—é™äºå…¶æ”¯æŒèŒƒå›´  |
| **è‡ªå»ºèšåˆå™¨**             | è‡ªä¸»å¯æ§ï¼Œå¯æ·±åº¦å®šåˆ¶ï¼Œçµæ´»è°ƒåº¦ | åˆæœŸå¼€å‘æˆæœ¬é«˜ï¼Œéœ€è¦ç»´æŠ¤ç¨³å®šæ€§ |

---

è®¡åˆ’å°† **AIèšåˆå™¨** éƒ¨ç½²åœ¨ **Cloudflare** ä¸Šï¼ˆWorkers + D1 + KV + R2 + AIï¼‰ï¼Œå¹¶ä¸”è¦ç»“åˆ Cloudflare æä¾›çš„ **AIèƒ½åŠ›**ï¼ˆWorkers AIã€Vectorize ç­‰ï¼‰ã€‚

# ğŸ“˜ é¡¹ç›®æ–‡æ¡£ï¼šAI èµ„æºèšåˆå™¨ï¼ˆCloudflare éƒ¨ç½²ç‰ˆï¼‰

## 1. é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ª **Web åº”ç”¨ï¼ˆAPIç½‘å…³ï¼‰**ï¼Œç»Ÿä¸€èšåˆå¤šä¸ª AI å¼•æ“ï¼ˆDeepSeekã€OpenAIã€Geminiã€OpenRouterã€ç¡…åŸºæµåŠ¨ã€Cloudflare AIç­‰ï¼‰ï¼Œå¹¶æä¾›æ ‡å‡†åŒ– API ç»™è‡ªæœ‰é¡¹ç›®è°ƒç”¨ã€‚
åŒæ—¶æ”¯æŒï¼š

* **æ™ºèƒ½è·¯ç”±**ï¼ˆæ ¹æ®æ¨¡å‹èƒ½åŠ›/æˆæœ¬/å»¶è¿Ÿè‡ªåŠ¨åˆ†æµï¼‰
* **ç»Ÿä¸€è®¤è¯**ï¼ˆAPI Key ä½“ç³»ï¼‰
* **æ—¥å¿—å­˜å‚¨**ï¼ˆè°ƒç”¨æ—¥å¿—ã€å“åº”æ—¶é—´ã€è´¹ç”¨è¿½è¸ªï¼‰
* **å¤šæ¨¡å‹æ‰©å±•**ï¼ˆå¯éšæ—¶å¢åŠ /ç§»é™¤åº•å±‚å¼•æ“ï¼‰

---

## 2. æŠ€æœ¯æ¶æ„

### ğŸ”¹ æ¶æ„å›¾ï¼ˆé€»è¾‘ï¼‰

```
[Client / Your Project]
          |
          v
  [Cloudflare Worker API Gateway]
          |
   ---------------------------
   |     Router Layer        |
   |  - ç»Ÿä¸€æ¥å£é€‚é…         |
   |  - æ¨¡å‹é€‰æ‹©ç­–ç•¥         |
   ---------------------------
   |   Connector Layer       |
   |  - OpenAI / DeepSeek    |
   |  - Gemini / OpenRouter  |
   |  - Cloudflare WorkersAI |
   ---------------------------
          |
   [Cloudflare D1 / KV / R2]
   - æ—¥å¿—å­˜å‚¨
   - Tokenç»Ÿè®¡
   - ç”¨æˆ·APIç®¡ç†
```

---

## 3. æŠ€æœ¯æ ˆ & å·¥å…·

* **Cloudflare Workers** â†’ æ ¸å¿ƒAPIè·¯ç”±å±‚ï¼ˆServerlessï¼‰
* **Cloudflare KV** â†’ å­˜å‚¨ç”¨æˆ·API Key / ç®€å•é…ç½®
* **Cloudflare D1 (SQLite)** â†’ è°ƒç”¨æ—¥å¿—ã€ç»Ÿè®¡æ•°æ®
* **Cloudflare Vectorize** â†’ å­˜å‚¨Embeddingï¼ˆå¯é€‰ï¼‰
* **Cloudflare Workers AI** â†’ æœ¬åœ°AIæ¨ç†èµ„æºï¼ˆå¦‚ `@cf/meta/llama-2-7b-chat-fp16`ï¼‰
* **å¤–éƒ¨API** â†’ OpenAI, DeepSeek, Gemini, OpenRouter, ç¡…åŸºæµåŠ¨
* **VS Code + Augment** â†’ æœ¬åœ°å¼€å‘ + è‡ªåŠ¨è¡¥å…¨ + éƒ¨ç½²

---

## 4. é¡¹ç›®ç»“æ„ï¼ˆVS Code å†…ï¼‰

```
ai-gateway/
 â”œâ”€ src/
 â”‚   â”œâ”€ index.ts            # å…¥å£ï¼ŒCloudflare Worker è·¯ç”±
 â”‚   â”œâ”€ router.ts           # è·¯ç”±é€»è¾‘ï¼ˆç»Ÿä¸€APIï¼‰
 â”‚   â”œâ”€ connectors/
 â”‚   â”‚    â”œâ”€ openai.ts
 â”‚   â”‚    â”œâ”€ deepseek.ts
 â”‚   â”‚    â”œâ”€ gemini.ts
 â”‚   â”‚    â”œâ”€ openrouter.ts
 â”‚   â”‚    â”œâ”€ siliconflow.ts
 â”‚   â”‚    â”œâ”€ cloudflare.ts
 â”‚   â”œâ”€ utils/
 â”‚   â”‚    â”œâ”€ logger.ts
 â”‚   â”‚    â”œâ”€ auth.ts
 â”‚   â”‚    â”œâ”€ config.ts
 â”‚   â””â”€ types.ts
 â”œâ”€ wrangler.toml           # Cloudflare é…ç½®
 â”œâ”€ package.json
 â”œâ”€ README.md
 â””â”€ .env (ä»…æœ¬åœ°è°ƒè¯•ç”¨)
```

---

## 5. è¯¦ç»†å®ç°

### 5.1 è·¯ç”±å±‚ï¼ˆç»Ÿä¸€APIï¼‰

`src/router.ts`

```ts
import { handleOpenAI } from "./connectors/openai";
import { handleDeepSeek } from "./connectors/deepseek";
import { handleGemini } from "./connectors/gemini";
import { handleOpenRouter } from "./connectors/openrouter";
import { handleSiliconFlow } from "./connectors/siliconflow";
import { handleCloudflareAI } from "./connectors/cloudflare";
import { logRequest } from "./utils/logger";
import { authenticate } from "./utils/auth";

export async function handleRequest(request: Request, env: any) {
  const url = new URL(request.url);
  const { pathname } = url;

  // è®¤è¯
  const user = await authenticate(request, env);
  if (!user) return new Response("Unauthorized", { status: 401 });

  // ç»Ÿä¸€æ¥å£
  if (pathname === "/v1/chat/completions") {
    const body = await request.json();
    const { provider } = body; // e.g. "openai" | "deepseek" | "gemini"

    let response;
    switch (provider) {
      case "openai":
        response = await handleOpenAI(body, env);
        break;
      case "deepseek":
        response = await handleDeepSeek(body, env);
        break;
      case "gemini":
        response = await handleGemini(body, env);
        break;
      case "openrouter":
        response = await handleOpenRouter(body, env);
        break;
      case "siliconflow":
        response = await handleSiliconFlow(body, env);
        break;
      case "cloudflare":
        response = await handleCloudflareAI(body, env);
        break;
      default:
        return new Response("Invalid provider", { status: 400 });
    }

    // æ—¥å¿—å­˜å‚¨
    await logRequest(user, provider, body, response, env);

    return new Response(JSON.stringify(response), {
      headers: { "Content-Type": "application/json" },
    });
  }

  return new Response("Not Found", { status: 404 });
}
```

---

### 5.2 OpenAI è¿æ¥å™¨ç¤ºä¾‹

`src/connectors/openai.ts`

```ts
export async function handleOpenAI(body: any, env: any) {
  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${env.OPENAI_API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: body.model || "gpt-4o-mini",
      messages: body.messages,
      max_tokens: body.max_tokens || 512
    })
  });
  return await resp.json();
}
```

åŒç†å¯ä¸º DeepSeekã€Geminiã€OpenRouterã€SiliconFlowã€CloudflareAI å„å†™ä¸€ä¸ªè¿æ¥å™¨ã€‚

---

### 5.3 æ—¥å¿—ä¸è®¤è¯

* **KV** å­˜å‚¨ `user_api_keys`
* **D1** å­˜å‚¨ `requests_log`ï¼ˆå­—æ®µï¼šuser\_id, provider, latency, tokens\_used, timestampï¼‰

`src/utils/auth.ts`

```ts
export async function authenticate(req: Request, env: any) {
  const apiKey = req.headers.get("x-api-key");
  if (!apiKey) return null;
  const stored = await env.KV_USERS.get(apiKey);
  return stored ? JSON.parse(stored) : null;
}
```

---

### 5.4 Wrangler é…ç½®

`wrangler.toml`

```toml
name = "ai-gateway"
main = "src/index.ts"
compatibility_date = "2024-08-01"

[[kv_namespaces]]
binding = "KV_USERS"
id = "xxxxxxxxxxxxx"

[[d1_databases]]
binding = "DB"
database_name = "ai_gateway_db"
database_id = "yyyyyyyyyyyyy"

[vars]
OPENAI_API_KEY = "sk-xxxx"
DEEPSEEK_API_KEY = "ds-xxxx"
GEMINI_API_KEY = "gm-xxxx"
OPENROUTER_API_KEY = "or-xxxx"
SILICONFLOW_API_KEY = "sf-xxxx"
```

---

## 6. æœ¬åœ°å¼€å‘ï¼ˆVS Code + Augmentï¼‰

### å®‰è£…ä¾èµ–

```bash
npm init -y
npm install typescript wrangler @cloudflare/workers-types
npx tsc --init
```

### æœ¬åœ°è°ƒè¯•

```bash
npx wrangler dev
```

è¯·æ±‚ç¤ºä¾‹ï¼š

```bash
curl -X POST "http://localhost:8787/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "x-api-key: test-key-123" \
  -d '{
    "provider": "openai",
    "messages": [{"role":"user","content":"Hello AI!"}]
  }'
```

---

## 7. æ‰©å±•æ–¹å‘

* **æ™ºèƒ½è·¯ç”±**ï¼šåŸºäºè°ƒç”¨å†å²å’Œæ¨¡å‹èƒ½åŠ›è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å‹ã€‚
* **å¤šæ¨¡æ€æ”¯æŒ**ï¼šGemini + Cloudflare AIï¼ˆå›¾åƒã€è§†é¢‘ã€embeddingï¼‰ã€‚
* **ç›‘æ§é¢æ¿**ï¼šç»“åˆ Cloudflare Analytics + D1ï¼Œåšä¸€ä¸ªå‰ç«¯ Dashboardï¼ˆå¯ç”¨ Next.js éƒ¨ç½²åœ¨ Cloudflare Pagesï¼‰ã€‚
* **API Key ç®¡ç†ç•Œé¢**ï¼šç®€å• Web ç•Œé¢ï¼Œç”¨æˆ·å¯ç”³è¯·/æ’¤é”€ API Keyã€‚

---
